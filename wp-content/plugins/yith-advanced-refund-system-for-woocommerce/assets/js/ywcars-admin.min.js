jQuery(function(a){a(document).ready(function(a){var t={init:function(){a(document.body).on("click","button.ywcars_accept_button",this.do_refund),a(document.body).on("click","button#ywcars_offer_coupon_button",this.create_coupon),a(document.body).on("click","button#ywcars_reject_request_button",this.reject),a(document.body).on("click","button#ywcars_processing_request_button",this.processing),a(document.body).on("click","button#ywcars_on_hold_request_button",this.on_hold),a(document.body).on("click","button#ywcars_close_request_button",this.close_request),a(document.body).on("click","#ywcars_submit_message",this.click_submit_message_button),a(document.body).on("submit","#post",this.submit_message),a(document.body).on("click","a.ywcars_update_messages",this.update_messages),a(document.body).on("click",".ywcars_close_alert",function(){a(this).closest("div.ywcars_alert").hide()}),this.check_disabled_buttons(),this.update_table_refund_total(),this.update_table_refund_subtotal(),this.custom_refund()},update_table_refund_total:function(){a(document.body).on("update_refund_total",function(){var t=a("td.ywcars_refund_total_data"),e=a("button span.amount"),r=0;a("input.ywcars_item_total").each(function(t){r+=parseFloat(a(this).val())}),r=accounting.formatNumber(r,ywcars_params.currency_format_num_decimals,""),a("#ywcars_refund_amount").val(r),a(this).trigger("check_disabled_buttons",r),r=accounting.formatMoney(r,{symbol:ywcars_params.currency_format_symbol,decimal:ywcars_params.currency_format_decimal_sep,thousand:ywcars_params.currency_format_thousand_sep,precision:ywcars_params.currency_format_num_decimals,format:ywcars_params.currency_format}),t.text(r),e.text(r)})},update_table_refund_subtotal:function(){var t=a('input[type="number"]'),e=a("input.ywcars_non_line_item_cb");t.change(function(){$row=a(this).closest("tr"),a(this).val()>0?$row.addClass("ywcars_items_table_highlight_single"):$row.removeClass("ywcars_items_table_highlight_single");var t=a("input#ywcars_restock_items"),e=t.closest("span").find("label");a(".ywcars_items_table_highlight_single").length?(t.prop("disabled",!1),e.css("color","#444")):(t.prop("checked",!1),t.prop("disabled",!0),e.css("color","gainsboro"));var r=$row.find("td.ywcars_item_data"),s=a("#ywcars_taxes_enabled").val(),c=parseFloat(r.find("input.ywcars_item_value").val()),o=parseFloat(r.find("input.ywcars_item_tax_value").val()),n=parseInt(r.find("input.ywcars_item_qty").val()),_=s?(c+o)*n:c*n;r.find("input.ywcars_item_total").val(_),$row.find("td.ywcars_refund_subtotal_data").text(accounting.formatMoney(_,{symbol:ywcars_params.currency_format_symbol,decimal:ywcars_params.currency_format_decimal_sep,thousand:ywcars_params.currency_format_thousand_sep,precision:ywcars_params.currency_format_num_decimals,format:ywcars_params.currency_format})),a(this).trigger("update_refund_total")}).change(),e.change(function(){$row=a(this).closest("tr");var t=$row.find("td.ywcars_non_line_item_data"),e=a("#ywcars_taxes_enabled").val(),r=parseFloat(t.find("input.ywcars_item_value").val()),s=parseFloat(t.find("input.ywcars_item_tax_value").val()),c=$row.find("td.ywcars_refund_subtotal_data"),o=0;a(this).is(":checked")?($row.addClass("ywcars_items_table_highlight_single"),o=e?r+s:r,c.text(accounting.formatMoney(o,{symbol:ywcars_params.currency_format_symbol,decimal:ywcars_params.currency_format_decimal_sep,thousand:ywcars_params.currency_format_thousand_sep,precision:ywcars_params.currency_format_num_decimals,format:ywcars_params.currency_format}))):($row.removeClass("ywcars_items_table_highlight_single"),o=0,c.text("")),t.find("input.ywcars_item_total").val(o),a(this).trigger("update_refund_total")}).change(),a("input#ywcars_restock_items").prop("checked",!0)},custom_refund:function(){var t=a(".ywcars_custom_refund_amount"),e=a("button span.amount");t.on("keyup",function(r){var s=a("td.ywcars_refund_total_data"),c=accounting.unformat(t.val(),ywcars_params.mon_decimal_point);c=accounting.formatNumber(c,ywcars_params.currency_format_num_decimals,""),a(this).trigger("check_disabled_buttons",c),a("#ywcars_refund_amount").val(c);var o=accounting.formatMoney(c,{symbol:ywcars_params.currency_format_symbol,decimal:ywcars_params.currency_format_decimal_sep,thousand:ywcars_params.currency_format_thousand_sep,precision:ywcars_params.currency_format_num_decimals,format:ywcars_params.currency_format});e.text(o),s.text(o)})},check_disabled_buttons:function(){a(document.body).on("check_disabled_buttons",function(t,e){var r=a("button.ywcars_request_action_button"),s=a("#ywcars_api_refund_button"),c=a("#ywcars_offer_coupon_button"),o=a("button#ywcars_reject_request_button"),n=a("button#ywcars_processing_request_button"),_=a("button#ywcars_on_hold_request_button"),i=!!a("input#ywcars_request_is_closed").val(),u=a("#ywcars_request_status").val(),d=parseFloat(a("input#ywcars_order_total").val());i||e<=0||e>d?r.prop("disabled",!0):(r.prop("disabled",!1),s.hasClass("disabled")&&s.prop("disabled",!0)),"ywcars-coupon"==u&&c.prop("disabled",!0),"ywcars-rejected"==u&&o.prop("disabled",!0),"ywcars-processing"==u&&n.prop("disabled",!0),"ywcars-on-hold"==u&&_.prop("disabled",!0)}),a(document.body).trigger("check_disabled_buttons")},do_refund:function(e){if(e.preventDefault(),t.block(),window.confirm(ywcars_params.i18n_do_refund)){var r=a("input#ywcars_request_id").val(),s=a("input#ywcars_order_id").val(),c=a("input#ywcars_refund_amount").val(),o={},n={},_={};a("tr.ywcars_items_table_highlight_single td.ywcars_item_data").each(function(t,e){item_id=a(e).find(".ywcars_item_id").val(),item_qty=parseInt(a(e).find(".ywcars_item_qty").val()),item_value=parseFloat(a(e).find(".ywcars_item_value").val()),item_total=item_value*item_qty,o[item_id]=item_qty,n[item_id]=accounting.unformat(item_total,ywcars_params.mon_decimal_point),_[item_id]={},item_taxes=a(e).find(".ywcars_item_tax").each(function(t,e){var r=a(e).data("tax_id"),s=parseFloat(e.value)*item_qty;_[item_id][r]=accounting.unformat(s,ywcars_params.mon_decimal_point)})});var i={action:"woocommerce_refund_line_items",ywcars_request_id:r,order_id:s,refund_amount:c,refund_reason:"",line_item_qtys:JSON.stringify(o,null,""),line_item_totals:JSON.stringify(n,null,""),line_item_tax_totals:JSON.stringify(_,null,""),api_refund:a(this).is(".do-api-refund"),restock_refunded_items:a("#ywcars_restock_items:checked").length?"true":"false",security:ywcars_params.order_item_nonce};a.post(ywcars_params.ajax_url,i,function(a){!0===a.success?(t.unblock(),window.location.href=window.location.href):(window.alert(a.data.error),t.unblock())})}else t.unblock()},create_coupon:function(e){e.preventDefault(),t.block();var r=a("input#ywcars_request_id").val(),s=a("input#ywcars_refund_amount").val(),c=accounting.formatMoney(s,{symbol:ywcars_params.currency_format_symbol,decimal:ywcars_params.currency_format_decimal_sep,thousand:ywcars_params.currency_format_thousand_sep,precision:ywcars_params.currency_format_num_decimals,format:ywcars_params.currency_format});if(window.confirm(ywcars_params.create_coupon+" "+c)){var o={action:"ywcars_create_coupon",ywcars_request_id:r,amount:s,security:ywcars_params.create_coupon_nonce};a.post(ywcars_params.ajax_url,o,function(a){!0===a.success?(t.unblock(),window.location.href=window.location.href):(window.alert(a.data.error),t.unblock())})}else t.unblock()},reject:function(e){e.preventDefault(),t.block();var r=a("input#ywcars_request_id").val();if(window.confirm(ywcars_params.reject)){var s={action:"ywcars_change_status",ywcars_request_id:r,ywcars_status:"ywcars-rejected",security:ywcars_params.change_status_nonce};a.post(ywcars_params.ajax_url,s,function(a){!0===a.success?(t.unblock(),window.location.href=window.location.href):(window.alert("Error: "+a.data.error),t.unblock())})}else t.unblock()},processing:function(e){e.preventDefault(),t.block();var r={action:"ywcars_change_status",ywcars_request_id:a("input#ywcars_request_id").val(),ywcars_status:"ywcars-processing",security:ywcars_params.change_status_nonce};a.post(ywcars_params.ajax_url,r,function(a){!0===a.success?(t.unblock(),window.location.href=window.location.href):(window.alert("Error: "+a.data.error),t.unblock())})},on_hold:function(e){e.preventDefault(),t.block();var r={action:"ywcars_change_status",ywcars_request_id:a("input#ywcars_request_id").val(),ywcars_status:"ywcars-on-hold",security:ywcars_params.change_status_nonce};a.post(ywcars_params.ajax_url,r,function(a){!0===a.success?(t.unblock(),window.location.href=window.location.href):(window.alert("Error: "+a.data.error),t.unblock())})},close_request:function(e){e.preventDefault(),t.block();var r=a("input#ywcars_request_id").val();if(window.confirm(ywcars_params.close_request)){var s={action:"ywcars_change_status",ywcars_request_id:r,ywcars_status:"ywcars-close-request",security:ywcars_params.change_status_nonce};a.post(ywcars_params.ajax_url,s,function(a){!0===a.success?(t.unblock(),window.location.href=window.location.href):(window.alert("Error: "+a.data.error),t.unblock())})}else t.unblock()},click_submit_message_button:function(t){t.preventDefault();a("#post").trigger("submit",!0)},submit_message:function(e){var r=a("textarea#ywcars_new_message"),s=a("input#ywcars_request_id").val();if(r.val()&&s){e.preventDefault(),form_data=new FormData(this),form_data.append("action","ywcars_submit_message"),form_data.append("security",ywcars_params.ywcars_submit_message),form_data.append("request_id",s);var c={type:"POST",url:ywcars_params.ajax_url,data:form_data,success:function(t,e,s){t.success&&"ywcars_message_submitted_correctly"==t.data?(a("div.ywcars_success_alert").show().find("span.ywcars_alert_content").text(ywcars_params.success_message),r.val("")):a("div.ywcars_error_alert").show().find("span.ywcars_alert_content").text(t.data)},error:function(t,e,r){a("div.ywcars_error_alert").show().find("span.ywcars_alert_content").text(r)},complete:function(){t.unblock_messages(),t.update_messages(e)},cache:!1,contentType:!1,processData:!1};t.block_messages({message:null,overlayCSS:{background:"#fff",opacity:.6}}),a.ajax(c)}else a("div.ywcars_error_alert").show().find("span.ywcars_alert_content").text(ywcars_params.fill_fields)},update_messages:function(e){e.preventDefault();var r=a("input#ywcars_request_id").val(),s=a("div.ywcars_messages_history_frame");if(r){var c={action:"ywcars_update_messages",security:ywcars_params.ywcars_update_messages,request_id:r};t.block_messages({message:null,overlayCSS:{background:"#fff",opacity:.6}}),a.post(ywcars_params.ajax_url,c,function(a){s.empty(),s.prepend(a),t.unblock_messages()})}},block:function(){a("#ywcars-items-metabox").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){a("#ywcars-items-metabox").unblock()},block_messages:function(){a("#ywcars-messages-metabox").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock_messages:function(){a("#ywcars-messages-metabox").unblock()}},e={init:function(){a(document.body).on("woocommerce_variations_loaded",this.on_variations),a("input.ywcars_ndays_radio").change({selector:"._ywcars_ndays_refund_field"},e.hide_fields_on_radio_group).change(),a("input.ywcars_message_radio").change({selector:"._ywcars_message_field"},e.hide_fields_on_radio_group).change()},on_variations:function(){a(".ywcars_refunds_product_variations_data").each(function(t,r){a(r).find("input.ywcars_ndays_radio").change({selector:"._ywcars_ndays_refund_variation_field"},e.hide_fields_on_radio_group),a(r).find("input.ywcars_message_radio").change({selector:"._ywcars_message_variation_field"},e.hide_fields_on_radio_group)})},hide_fields_on_radio_group:function(t){var e=a(t.data.selector);"custom"==a(this).filter(":checked").val()?e.show():e.hide()}};t.init(),e.init()})});